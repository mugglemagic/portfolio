<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)" />
		<meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)" />
		<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
		<link rel="manifest" href="/manifest.webmanifest" />
		<!-- Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet" />
		
		<link href="../_app/immutable/assets/0.BF8zXpst.css" rel="stylesheet">
		<link rel="modulepreload" href="../_app/immutable/entry/start.gJeQT9fj.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/XUMD-9Mr.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BNPA_p_8.js">
		<link rel="modulepreload" href="../_app/immutable/entry/app.6Y1gGeRj.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DCf4JqPx.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B-iva8rw.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/C8YSO-qe.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/BqisEWkp.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/B4GcWvgj.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/0.B6H7cPzz.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/DmT9Q6NN.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/D0ihxO46.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Dg5uvz-Z.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/IVcZ5moH.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/Cw41v0MJ.js">
		<link rel="modulepreload" href="../_app/immutable/nodes/5.DBA4cNcK.js">
		<link rel="modulepreload" href="../_app/immutable/chunks/QRiZD35W.js"><!--1mz03nk--><!--[!--><!--]--> <!----><script>(function setInitialMode({ defaultMode = "system", themeColors: themeColors2, darkClassNames: darkClassNames2 = ["dark"], lightClassNames: lightClassNames2 = [], defaultTheme = "", modeStorageKey: modeStorageKey2 = "mode-watcher-mode", themeStorageKey: themeStorageKey2 = "mode-watcher-theme" }) {
  const rootEl = document.documentElement;
  const mode = localStorage.getItem(modeStorageKey2) ?? defaultMode;
  const theme = localStorage.getItem(themeStorageKey2) ?? defaultTheme;
  const light = mode === "light" || mode === "system" && window.matchMedia("(prefers-color-scheme: light)").matches;
  if (light) {
    if (darkClassNames2.length)
      rootEl.classList.remove(...darkClassNames2.filter(Boolean));
    if (lightClassNames2.length)
      rootEl.classList.add(...lightClassNames2.filter(Boolean));
  } else {
    if (lightClassNames2.length)
      rootEl.classList.remove(...lightClassNames2.filter(Boolean));
    if (darkClassNames2.length)
      rootEl.classList.add(...darkClassNames2.filter(Boolean));
  }
  rootEl.style.colorScheme = light ? "light" : "dark";
  if (themeColors2) {
    const themeMetaEl = document.querySelector('meta[name="theme-color"]');
    if (themeMetaEl) {
      themeMetaEl.setAttribute("content", mode === "light" ? themeColors2.light : themeColors2.dark);
    }
  }
  if (theme) {
    rootEl.setAttribute("data-theme", theme);
    localStorage.setItem(themeStorageKey2, theme);
  }
  localStorage.setItem(modeStorageKey2, mode);
})({"defaultMode":"system","darkClassNames":["dark"],"lightClassNames":[],"defaultTheme":"","modeStorageKey":"mode-watcher-mode","themeStorageKey":"mode-watcher-theme"});</script><!----><!----><!--ojxrft--><meta name="description" content="How we designed our security architecture with server-side JWT validation, CSRF protection, and why we never trust the client."/> <link rel="canonical" href="https://markbasford.com/blog/FR-0005-the-server-side-shield"/> <meta property="og:type" content="article"/> <meta property="og:url" content="https://markbasford.com/blog/FR-0005-the-server-side-shield"/> <meta property="og:title" content="The Server-Side Shield | Mark Basford"/> <meta property="og:description" content="How we designed our security architecture with server-side JWT validation, CSRF protection, and why we never trust the client."/> <meta property="og:image" content="https://markbasford.com/headshot.jpg"/> <meta property="og:image:width" content="1200"/> <meta property="og:image:height" content="630"/> <meta name="twitter:card" content="summary_large_image"/> <meta name="twitter:title" content="The Server-Side Shield | Mark Basford"/> <meta name="twitter:description" content="How we designed our security architecture with server-side JWT validation, CSRF protection, and why we never trust the client."/> <meta name="twitter:image" content="https://markbasford.com/headshot.jpg"/> <!--[--><meta name="author" content="Mark Basford"/> <!--[--><meta property="article:published_time" content="2025-01-20T00:00:00.000Z"/><!--]--> <meta property="article:author" content="Mark Basford"/> <!--[--><meta property="article:tag" content="security, architecture, authentication, csrf, jwt, server-actions"/><!--]--><!--]--> <!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"Person","name":"Mark Basford","url":"https://markbasford.com","jobTitle":"Frontend Architect","description":"Frontend architect specialising in accessibility-first development","sameAs":["https://www.linkedin.com/in/mark-basford-78a43390/","https://github.com/mugglemagic"],"knowsAbout":["Web Accessibility","Frontend Development","React","Vue","SvelteKit","TypeScript","PHP","Laravel"]}</script><!----> <!--[--><!----><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Server-Side Shield | Mark Basford","description":"How we designed our security architecture with server-side JWT validation, CSRF protection, and why we never trust the client.","datePublished":"2025-01-20T00:00:00.000Z","author":{"@type":"Person","name":"Mark Basford","url":"https://markbasford.com"},"publisher":{"@type":"Person","name":"Mark Basford"}}</script><!----><!--]--><!----><title>The Server-Side Shield | Mark Basford</title>
	</head>
	<body data-sveltekit-preload-data="hover">
		<div style="display: contents"><!--[--><!--[--><!----><!--[!--><!--]--><!----> <a href="#main-content" class="skip-link svelte-supu7d">Skip to main content</a><!----> <div class="flex min-h-screen flex-col"><header class="border-b border-border"><div class="mx-auto flex max-w-4xl items-center justify-between px-6 py-6"><a href="/" class="text-lg font-medium tracking-tight transition-opacity hover:opacity-60">Mark Basford</a> <nav aria-label="Main navigation" class="flex items-center gap-1"><!--[--><a href="/" class="min-h-[44px] min-w-[44px] inline-flex items-center justify-center px-4 py-2 text-sm transition-opacity hover:opacity-60 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-ring opacity-60">Home</a><a href="/about" class="min-h-[44px] min-w-[44px] inline-flex items-center justify-center px-4 py-2 text-sm transition-opacity hover:opacity-60 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-ring opacity-60">About</a><a href="/blog" class="min-h-[44px] min-w-[44px] inline-flex items-center justify-center px-4 py-2 text-sm transition-opacity hover:opacity-60 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-ring opacity-100" aria-current="page">Blog</a><!--]--> <!--[!--><button data-slot="button" class="focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive inline-flex shrink-0 items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium outline-none transition-all focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&amp;_svg:not([class*='size-'])]:size-4 [&amp;_svg]:pointer-events-none [&amp;_svg]:shrink-0 hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50 size-9 min-h-[44px] min-w-[44px]" type="button" aria-label="Toggle theme"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="hidden dark:block"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" class="block dark:hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg><!----></button><!--]--><!----></nav></div></header><!----> <main id="main-content" tabindex="-1" class="flex-1"><!----><!----> <article class="mx-auto max-w-3xl px-6 py-16 md:py-24"><header class="mb-16"><a href="/blog" class="label mb-8 inline-flex min-h-[44px] items-center gap-2 transition-transform hover:opacity-60"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg> Back to blog</a> <h1 class="mb-6">The Server-Side Shield</h1> <div class="flex flex-wrap items-center gap-3"><time datetime="2025-01-20T00:00:00.000Z" class="label">20 January 2025</time> <!--[--><span class="text-border">|</span> <!--[--><span class="label">security</span><span class="label">architecture</span><span class="label">authentication</span><span class="label">csrf</span><span class="label">jwt</span><span class="label">server-actions</span><!--]--><!--]--></div></header> <div class="prose"><!--[--><!----><p>In the 1940s, American banks faced a problem: how do you let customers transact without letting them anywhere near the vault? Their solution was the pneumatic tube - a pressurised cylinder that whooshed capsules between the customer window and the teller’s station. The interaction felt almost playful. What customers didn’t see: reinforced tubing, one-way valves, the physical impossibility of reaching through to the other side. The friendly whoosh masked a deliberate architectural boundary.</p> <p>The technology spread to department stores, hospitals, and eventually some British banks in the 1960s. Most have been replaced now. But the principle endures.</p> <p>We found ourselves thinking about pneumatic tubes when designing how our frontend talks to the backend.</p> <h2>The Invisible Attack Surface</h2> <p>In May 2024, security researchers reverse-engineering the Rabbit R1 AI device discovered something that should have been impossible to find: API keys hardcoded directly into the client-side code. Not just any keys - the ElevenLabs key had full administrative privileges. With that single exposed credential, attackers could access the complete history of every text-to-speech message ever generated by any R1 device.</p> <p>The keys had been sitting there, in code that shipped to every customer, for months.</p> <p>This wasn’t a sophisticated attack. Someone looked at the client bundle and found secrets that should never have left the server. The Rabbit team presumably knew better. Most developers know better. And yet IBM’s research shows that breaches involving stolen credentials take an average of 292 days to detect - longer than any other attack vector. The secrets leak quietly. The damage accumulates invisibly.</p> <p>We didn’t want to learn this lesson firsthand.</p> <h2>The Principle</h2> <p>The architecture is simple to state: the browser never talks directly to the backend API. Every request goes through the server.</p> <pre class="language-undefined"><!----><code class="language-undefined">Browser → Next.js Server → Backend API</code><!----></pre> <p>Not browser to backend. Not client-side fetch calls with API keys tucked into environment variables. The browser talks to our Next.js server, which talks to the backend. The browser never sees the backend URL, never handles authentication tokens directly, never has access to secrets that could be extracted from a bundle.</p> <p>The pneumatic tube, not the open window.</p> <h2>Server Actions as the Boundary</h2> <p>Next.js Server Actions give us a clean way to enforce this boundary. Any function marked with <code>'use server'</code> runs exclusively on the Node.js server - it physically cannot execute in the browser.</p> <pre class="language-typescript"><!----><code class="language-typescript"><span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>credentials<span class="token operator">:</span> Credentials<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">createSecureClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> http<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth/login'</span><span class="token punctuation">,</span> credentials<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>That <code>'use server'</code> directive isn’t a suggestion. The bundler strips these functions from client code entirely. They exist only on the server. The credentials go in, the response comes out, but the actual HTTP call to the backend happens in a context the browser cannot inspect.</p> <p>Every authentication function in our codebase follows this pattern. Login, signup, OTP validation, session management - all server actions. The browser submits form data; the server handles the sensitive operations.</p> <h2>CSRF Protection</h2> <p>Server-side API calls solve the secret exposure problem, but they don’t prevent cross-site request forgery. If a malicious site can trick a user’s browser into submitting a form to our server, the server would dutifully forward that request to the backend.</p> <p>We use Laravel Sanctum’s CSRF protection, integrated through axios interceptors:</p> <pre class="language-typescript"><!----><code class="language-typescript"><span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createSecureClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cookieStore <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> client <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span>
    withCredentials<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    withXSRFToken<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  client<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> token <span class="token operator">=</span> cookieStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'XSRF-TOKEN'</span><span class="token punctuation">)</span><span class="token operator">?.</span>value<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      config<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'X-XSRF-TOKEN'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">decodeURIComponent</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> client<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>The flow: when the application loads, we fetch a CSRF token from the backend. That token lives in a cookie. Every subsequent request includes the token in a header. The backend validates that the header matches the cookie - something a cross-site attacker cannot forge because they can’t read our cookies.</p> <p>The axios instance itself is created server-side. The interceptor runs server-side. The cookie reading happens server-side. The browser never touches the CSRF machinery directly.</p> <h2>Environment Isolation</h2> <p>Here’s where the pneumatic tube metaphor becomes concrete. Consider a typical environment configuration:</p> <pre class="language-typescript"><!----><code class="language-typescript"><span class="token keyword">export</span> <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Server-side only - never exposed to browser</span>
  signingSecret<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SIGNING_SECRET</span><span class="token punctuation">,</span>
  apiEndpoint<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">API_ENDPOINT</span><span class="token punctuation">,</span>
  cookieName<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">COOKIE_NAME</span><span class="token punctuation">,</span>

  <span class="token comment">// Public - explicitly prefixed, safe to expose</span>
  appTitle<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NEXT_PUBLIC_APP_TITLE</span><span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span></code><!----></pre> <p>The <code>NEXT_PUBLIC_</code> prefix is the boundary. Variables without that prefix exist only in the server runtime. They’re not bundled, not shipped to browsers, not inspectable in DevTools. The signing secret, the API endpoint, the cookie name - none of it leaves the server.</p> <p>If someone decompiles our client bundle, they’ll find nothing useful. The secrets are on the other side of the tube.</p> <h2>JWT Session Management</h2> <p>When a user authenticates successfully, we generate a session token. This happens entirely server-side:</p> <pre class="language-typescript"><!----><code class="language-typescript"><span class="token string">'use server'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">createSession</span><span class="token punctuation">(</span>
  user<span class="token operator">:</span> UserData<span class="token punctuation">,</span>
  expiresAt<span class="token operator">:</span> Date
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> cookieStore <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">SignJWT</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> user <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setProtectedHeader</span><span class="token punctuation">(</span><span class="token punctuation">&#123;</span> alg<span class="token operator">:</span> <span class="token string">'HS256'</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">setExpirationTime</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>expiresAt<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TextEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>signingSecret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cookieStore<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'session'</span><span class="token punctuation">,</span> token<span class="token punctuation">,</span> <span class="token punctuation">&#123;</span>
    httpOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    secure<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
    sameSite<span class="token operator">:</span> <span class="token string">'lax'</span><span class="token punctuation">,</span>
    path<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">,</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code><!----></pre> <p>The JWT is signed with a secret the browser never sees. It’s stored in an <code>httpOnly</code> cookie the browser cannot read via JavaScript. The <code>sameSite: 'lax'</code> flag prevents the cookie from being sent on cross-site requests. The <code>secure</code> flag ensures HTTPS-only transmission in production.</p> <p>Four layers of protection, none of which require the browser to be trusted.</p> <h2>Events as a Security Layer</h2> <p>There’s one more boundary worth mentioning. Our forms don’t call server actions directly - they publish events.</p> <pre class="language-typescript"><!----><code class="language-typescript"><span class="token comment">// Client component publishes intent</span>
<span class="token keyword">const</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">await</span> events<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'auth.login.requested'</span><span class="token punctuation">,</span> values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// Server-side handler subscribes and executes</span>
events<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token string">'auth.login.requested'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> events<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">'auth.login.completed'</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code><!----></pre> <p>The client expresses intent. The server decides what to do with it. The client never knows the API structure, the endpoint URLs, or the response handling logic. It publishes an event and waits for a result.</p> <p>This decoupling has security benefits beyond obscurity. Every event is validated against a schema. Every event is logged for audit trails. The event system becomes a checkpoint where we can add rate limiting, validation, or security monitoring without touching the UI code.</p> <p>We’ll explore the event architecture more deeply in a future post. For now, the relevant point is that it adds another layer to the shield.</p> <h2>What We Prevent</h2> <table><thead><tr><th>Threat</th><th>Mitigation</th></tr></thead><tbody><tr><td>Secret exposure in bundles</td><td>Server-side only, no <code>NEXT_PUBLIC_</code> prefix</td></tr><tr><td>CSRF attacks</td><td>XSRF-TOKEN + SameSite cookies</td></tr><tr><td>XSS token theft</td><td>HttpOnly cookies, server-side JWT</td></tr><tr><td>API structure exposure</td><td>Event-driven indirection</td></tr><tr><td>Session hijacking</td><td>HTTPS-only, short TTL, secure cookies</td></tr><tr><td>Credential interception</td><td>Server-to-server communication</td></tr></tbody></table> <p>None of these mitigations are novel. They’re well-documented security practices. The architecture just ensures they’re applied consistently, by default, without requiring every developer to remember the rules.</p> <h2>The Tube, Not the Window</h2> <p>The pneumatic tube worked because you physically cannot reach through it. The capsule goes in, the capsule comes out, but the mechanism - the pressure, the valves, the routing - happens in a space you cannot access.</p> <p>Our server-side architecture works the same way. The browser sends requests, receives responses, but never touches the machinery that processes them. The secrets stay on the server. The API calls happen server-to-server. The authentication tokens live in cookies the browser cannot read.</p> <p>It’s not clever. It’s not innovative. It’s just a boundary, consistently enforced, that prevents an entire category of vulnerabilities from being possible in the first place.</p> <p>Sometimes the best security is the attack surface that doesn’t exist.</p> <hr/> <h2>Technical Notes</h2> <p><strong>Patterns Used:</strong></p> <ul><li>Next.js Server Actions (<code>'use server'</code> directive)</li> <li>CSRF protection via Sanctum integration</li> <li>JWT signing with jose library</li> <li>HttpOnly + SameSite + Secure cookies</li> <li>Event-driven form handling</li></ul> <p><strong>Related Posts:</strong></p> <ul><li>FR-0001: The Multizone Gambit</li> <li>FR-0014: Seven Ways to Deliver an Event (coming soon)</li></ul> <p><strong>References:</strong></p> <ul><li><a href="https://rabbitu.de/articles/security-disclosure-1" rel="nofollow">Rabbit R1 Security Disclosure</a></li> <li><a href="https://www.ibm.com/security/data-breach" rel="nofollow">IBM Cost of a Data Breach Report 2024</a></li> <li><a href="https://owasp.org/API-Security/" rel="nofollow">OWASP API Security Top 10</a></li></ul> <hr/> <h2>A Note on How This Was Written</h2> <p>As with all posts in this series, this was written with AI assistance. The architectural decisions and security patterns are real implementations in our codebase. The Rabbit R1 incident informed our thinking before we wrote a line of authentication code - learning from others’ mistakes being preferable to making our own. Every code example is representative of the patterns we use.</p><!----><!--]--></div></article><!----><!----></main> <footer class="border-t border-border"><div class="mx-auto flex max-w-4xl flex-col items-center gap-6 px-6 py-12 sm:flex-row sm:justify-between"><p class="text-sm text-muted-foreground">© 2025 Mark Basford</p> <nav aria-label="Social links" class="flex items-center gap-2"><!--[--><a href="https://www.linkedin.com/in/mark-basford-78a43390/" target="_blank" rel="noopener noreferrer" class="inline-flex min-h-[44px] min-w-[44px] items-center justify-center rounded-md p-2 transition-opacity hover:opacity-70 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring" aria-label="LinkedIn (opens in new tab)"><!--[--><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect width="4" height="12" x="2" y="9"></rect><circle cx="4" cy="4" r="2"></circle></svg><!--]--></a><a href="https://github.com/mugglemagic" target="_blank" rel="noopener noreferrer" class="inline-flex min-h-[44px] min-w-[44px] items-center justify-center rounded-md p-2 transition-opacity hover:opacity-70 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-ring" aria-label="GitHub (opens in new tab)"><!--[!--><!--[--><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"></path><path d="M9 18c-4.51 2-5-2-7-2"></path></svg><!--]--><!--]--></a><!--]--></nav><!----></div></footer><!----></div><!----><!--]--> <!--[!--><!--]--><!--]-->
			
			<script>
				{
					__sveltekit_moh665 = {
						base: new URL("..", location).pathname.slice(0, -1)
					};

					const element = document.currentScript.parentElement;

					Promise.all([
						import("../_app/immutable/entry/start.gJeQT9fj.js"),
						import("../_app/immutable/entry/app.6Y1gGeRj.js")
					]).then(([kit, app]) => {
						kit.start(app, element, {
							node_ids: [0, 5],
							data: [null,null],
							form: null,
							error: null
						});
					});
				}
			</script>
		</div>
	</body>
</html>
